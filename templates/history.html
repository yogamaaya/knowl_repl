<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Knowl History</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="history-container">
        <h1>Document History ðŸ“š</h1>
        <div id="docList" class="doc-list"></div>
        <a href="/" class="back-button">Back to Chat</a>
    </div>
    <script>
        async function loadDocHistory() {
            try {
                const response = await fetch('/load_doc_history');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load history');
                }
                const docHistory = data.docHistory || [];
                localStorage.setItem('docHistory', JSON.stringify(docHistory));
                const docList = document.getElementById('docList');
                docList.innerHTML = '';
                
                for (const doc of docHistory) {
                    const docItem = document.createElement('article');
                    docItem.className = 'doc-item';
                    
                    const header = document.createElement('header');
                    header.className = 'doc-header';
                    
                    const titleButton = document.createElement('button');
                    titleButton.className = 'doc-title-button';
                    titleButton.textContent = doc.title;
                    
                    const preview = document.createElement('div');
                    preview.className = 'doc-preview collapsed';
                    
                    header.appendChild(titleButton);
                    docItem.appendChild(titleButton);
                    docItem.appendChild(preview);
                    
                    let hasContent = false;
                    
                    titleButton.addEventListener('click', async function() {
                        if (!hasContent) {
                            titleButton.disabled = true;
                            try {
                                const response = await fetch('/get_doc_preview', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ doc_id: doc.id })
                                });
                                const data = await response.json();
                                preview.innerHTML = `
                                    <p>${data.preview}</p>
                                    <a href="https://docs.google.com/document/d/${doc.id}/edit" target="_blank" class="read-more">Read More â†’</a>
                                `;
                                hasContent = true;
                            } catch (error) {
                                console.error('Error fetching preview:', error);
                                return;
                            } finally {
                                titleButton.disabled = false;
                            }
                        }
                        
                        preview.classList.toggle('show');
                        titleButton.classList.toggle('active');
                    });
                    
                    docList.appendChild(docItem);
                }
            } catch (error) {
                console.error('Error loading doc history:', error);
            }
        }

        // Load history once when page loads
        window.onload = loadDocHistory;

        // Auto-refresh history every 5 seconds
        setInterval(loadDocHistory, 5000);
        
        // Also listen for manual refresh messages
        window.addEventListener('message', (event) => {
            if (event.data === 'refreshHistory') {
                loadDocHistory();
            }
        });
    </script>
</body>
</html>